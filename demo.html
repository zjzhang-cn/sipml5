<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <!-- Le styles -->
  <link href="./assets/css/bootstrap.css" rel="stylesheet" />
  <script src="SIPml-api.js?svn=252" type="text/javascript"> </script>
  <script type="text/javascript">
    var oSipStack, oSipSessionRegister, oSipSessionCall, oSipSessionTransferCall;
    var oSipMessage;
  </script>
</head>

<body>
  <input type="text" id="txtRealm" value="sipjs.onsip.com" />
  <input type="text" id="txtImpi" value="1001" />
  <input type="password" id="txtPassword" value="1234" />
  <input type="text" id="txtWss" value="wss://edge.sip.onsip.com/" />
  <input type="button" class="btn btn-success" id="btnInit" value="注册" onclick='sipInit();' />
  <br/>
  <input type="text" id="txtPhoneNumber" value="6310" />
  <input type="button" class="btn btn-success" id="btnAccept" value="应答" onclick='sipAccept();' />
  <input type="button" class="btn btn-success" id="btnCallVideo" value="呼叫Video" onclick='sipCall("call-audiovideo");' />
  <input type="button" class="btn btn-success" id="btnCallAudio" value="呼叫Audio" onclick='sipCall("call-audio");' />
  <input type="button" class="btn btn-success" id="btnHangUp" value="挂机" onclick='sipHangUp();' />
  <input type="button" class="btn btn-success" id="btnMute" value="静音"  />
  <input type="button" class="btn btn-success" id="btnHold" value="Hold"  />
  <input type="button" class="btn btn-success" id="btnVideo" value="Enable Video" onclick='enableVideo();' />
  <br/>
  <input type="text" id="txtTransferNumber" value="1002" />
  <input type="button" class="btn btn-success" id="btnTransfer" value="转移" />
  <br/>
  <input type="text" id="txtLayout" value="3x2" />
  <input type="button" class="btn btn-success" id="btnLayout" value="混屏设置" onclick='meetingLayout();' />

  <br/>
  <div id='divKeyPad' class='span2 well div-keypad' style=" width:250; height:240;">
    <table style="width: 100%; height: 100%">
      <tr>
        <td><input type="button" style="width: 33%" class="btn" value="1" onclick="sipSendDTMF('1');" /><input type="button"
            style="width: 33%" class="btn" value="2" onclick="sipSendDTMF('2');" /><input type="button" style="width: 33%"
            class="btn" value="3" onclick="sipSendDTMF('3');" /></td>
      </tr>
      <tr>
        <td><input type="button" style="width: 33%" class="btn" value="4" onclick="sipSendDTMF('4');" /><input type="button"
            style="width: 33%" class="btn" value="5" onclick="sipSendDTMF('5');" /><input type="button" style="width: 33%"
            class="btn" value="6" onclick="sipSendDTMF('6');" /></td>
      </tr>
      <tr>
        <td><input type="button" style="width: 33%" class="btn" value="7" onclick="sipSendDTMF('7');" /><input type="button"
            style="width: 33%" class="btn" value="8" onclick="sipSendDTMF('8');" /><input type="button" style="width: 33%"
            class="btn" value="9" onclick="sipSendDTMF('9');" /></td>
      </tr>
      <tr>
        <td><input type="button" style="width: 33%" class="btn" value="*" onclick="sipSendDTMF('*');" /><input type="button"
            style="width: 33%" class="btn" value="0" onclick="sipSendDTMF('0');" /><input type="button" style="width: 33%"
            class="btn" value="#" onclick="sipSendDTMF('#');" /></td>
      </tr>
    </table>
  </div>
  <audio id="audio-remote" width="0px'" height="0px" autoplay="autoplay" ></audio>
  <video id="video-remote" width="480px'" height="320px" autoplay="autoplay" ></video>
  <video id="video-local" width="80px'" height="60px" autoplay="autoplay" muted="true" ></video>

<script type="text/javascript">
  function sipSendDTMF(c) {
    if (oSipSessionCall && c) {
      if (oSipSessionCall.dtmf(c) == 0) {
        try { dtmfTone.play(); } catch (e) { }
      }
    }
  }
  function sipAccept() {
    if (oSipSessionCall) {
      oSipSessionCall.accept(oConfigCall);
    }
  }

  function sipCall(call_type) {
      oSipSessionCall = oSipStack.newSession(call_type, oConfigCall);
      oSipSessionCall.call(txtPhoneNumber.value);
  }

  function sipHangUp() {
    if (oSipSessionCall) {
      oSipSessionCall.hangup({ events_listener: { events: '*', listener: onSipEventSession } });
    }
  }


  var oConfigCall = {
    audio_remote: document.getElementById('audio-remote'),
    video_local: document.getElementById('video-local'),
    video_remote: document.getElementById('video-remote'),
    enable_media_stream_cache:true,
    events_listener: { events: '*', listener: onSipEventSession },
  };
  function onSipEventMessage(e /* SIPml.Session.Event */) {
    console.log(e)
  }
  function onSipEventSession(e /* SIPml.Session.Event */) {
    console.log(e)
    console.log(e.type)
    switch (e.type) {
      case 'terminating': case 'terminated': {
        if (e.session == oSipSessionCall) {
          oSipSessionCall = null;
        }
        break;
      }

    }
  }
  sipInit = function () {
    var realm=txtRealm.value;
    var impi=txtImpi.value;
    var password=txtPassword.value;
    var websocket_proxy_url=txtWss.value;
    SIPml.init(
      function (e) {
        oSipStack = new SIPml.Stack({
          ice_servers: "[]",
          realm: realm,
          impi: impi,
          impu: 'sip:'+impi+'@'+realm,
          password: password,
          websocket_proxy_url: websocket_proxy_url,
          enable_media_stream_cache: true,
          //outbound_proxy_url: 'sip://10.21.19.18',
          sip_headers: [
            { name: 'User-Agent', value: 'IM-client/OMA1.0 sipML5-v1.2016.03.04' },
            { name: 'Organization', value: 'Doubango Telecom' }
          ],
          events_listener: {
            events: '*', listener: function (e) {
              console.log(e)
              switch (e.type) {
                case 'i_new_message': {
                  var msg = e.newSession;
                  msg.accept()
                  break
                }
                case 'started': {
                  btnInit.disabled=true;
                  oSipMessage = this.newSession('message', {
                    //events_listener: { events: '*', listener: onSipEventMessage }
                  });
                  oSipSessionRegister = this.newSession('register', {
                    expires: 200,
                    events_listener: { events: '*', listener: onSipEventSession }
                  });
                  oSipSessionRegister.register();
                  break;
                }
                case 'stopping': case 'stopped': case 'failed_to_start': case 'failed_to_stop':{
                  break;
                }
                case 'i_new_call': {
                  if (oSipSessionCall) {
                    // do not accept the incoming call if we're already 'in call'
                    e.newSession.hangup(oConfigCall); // comment this line for multi-line support
                  } else {
                    if (e.newSession) {
                      oSipSessionCall = e.newSession;
                      oSipSessionCall.setConfiguration(oConfigCall);
                      
                    }
                  }
                  break;
                }
                case 'm_permission_requested':
                    {
                        break;
                    }
                case 'm_permission_accepted':
                case 'm_permission_refused':
                    {
                        break;
                    }

              }
            }
          }
        });
        oSipStack.start();
      }
    );
  }
</script>
</body>
</html>